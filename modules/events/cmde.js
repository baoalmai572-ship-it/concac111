const path = require("path");
module.exports.config = {
    name: "cmde",
    version: "1.0.0",
    hasPermssion: 2,
    credits: "Mirai Team ",
    description: "Qu·∫£n l√Ω/Ki·ªÉm so√°t to√†n b·ªô event module c·ªßa bot",
    commandCategory: "H·ªá Th·ªëng",
    usePrefix: false,
    usages: "[load/unload/loadAll/unloadAll/info] [t√™n event]",
    cooldowns: 2,
    dependencies: {
        "fs-extra": "",
        "child_process": "",
        "path": ""
    }
};

// Load Event
const loadEvent = function ({ moduleList, threadID, messageID }) {
    const { execSync } = global.nodemodule['child_process'];
    const { writeFileSync, unlinkSync, readFileSync } = global.nodemodule['fs-extra'];
    const { join } = global.nodemodule['path'];
    const { configPath, mainPath, api } = global.client;
    const logger = require(mainPath + '/pdata/utils/log');
    var errorList = [];
    delete require['resolve'][require['resolve'](configPath)];
    var configValue = require(configPath);
    writeFileSync(configPath + '.temp', JSON.stringify(configValue, null, 2), 'utf8');
    for (const nameModule of moduleList) {
        try {
            const dirModule = __dirname + '/' + nameModule + '.js';
            delete require['cache'][require['resolve'](dirModule)];
            const event = require(dirModule);
            global.client.events.delete(nameModule);
            if (!event.config || !event.run) 
                throw new Error('[ ùóñùó†ùóóùóò ] - Event kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!');
            // C·∫≠p nh·∫≠t config module n·∫øu c√≥
            if (event.config.dependencies && typeof event.config.dependencies == 'object') {
                const listPackage = JSON.parse(readFileSync('./package.json')).dependencies,
                    listbuiltinModules = require('module')['builtinModules'];
                for (const packageName in event.config.dependencies) {
                    var tryLoadCount = 0,
                        loadSuccess = false,
                        error;
                    const moduleDir = join(global.client.mainPath, 'nodemodules', 'node_modules', packageName);
                    try {
                        if (listPackage.hasOwnProperty(packageName) || listbuiltinModules.includes(packageName)) global.nodemodule[packageName] = require(packageName);
                        else global.nodemodule[packageName] = require(moduleDir);
                    } catch {
                        logger.loader('[ ùóñùó†ùóóùóò ] - Kh√¥ng t√¨m th·∫•y package ' + packageName + ' h·ªó tr·ª£ cho event ' + event.config.name + ' ti·∫øn h√†nh c√†i ƒë·∫∑t...', 'warn');
                        const insPack = {};
                        insPack.stdio = 'inherit';
                        insPack.env = process.env ;
                        insPack.shell = true;
                        insPack.cwd = join(global.client.mainPath,'nodemodules')
                        execSync('npm --package-lock false --save install ' + packageName + (event.config.dependencies[packageName] == '*' || event.config.dependencies[packageName] == '' ? '' : '@' + event.config.dependencies[packageName]), insPack);
                        for (tryLoadCount = 1; tryLoadCount <= 3; tryLoadCount++) {
                            require['cache'] = {};
                            try {
                                if (listPackage.hasOwnProperty(packageName) || listbuiltinModules.includes(packageName)) global.nodemodule[packageName] = require(packageName);
                                else global.nodemodule[packageName] = require(moduleDir);
                                loadSuccess = true;
                                break;
                            } catch (erorr) {
                                error = erorr;
                            }
                            if (loadSuccess || !error) break;
                        }
                        if (!loadSuccess || error) throw 'Kh√¥ng th·ªÉ t·∫£i package ' + packageName + (' cho event ') + event.config.name +', l·ªói: ' + error + ' ' + error['stack'];
                    }
                }
                logger.loader('[ ùóñùó†ùóóùóò ] -  ƒê√£ t·∫£i th√†nh c√¥ng to√†n b·ªô package cho event ' + event.config.name);
            }
            if (event.config.envConfig && typeof event.config.envConfig == 'Object') try {
                for (const [key, value] of Object.entries(event.config.envConfig)) {
                    if (typeof global.configModule[event.config.name] === "undefined") 
                        global.configModule[event.config.name] = {};
                    if (typeof configValue[event.config.name] === "undefined") 
                        configValue[event.config.name] = {};
                    if (typeof configValue[event.config.name][key] !== "undefined") 
                        global.configModule[event.config.name][key] = configValue[event.config.name][key];
                    else global.configModule[event.config.name][key] = value || '';
                    if (typeof configValue[event.config.name][key] === "undefined") 
                        configValue[event.config.name][key] = value || '';
                }
                logger.loader('Loaded config ' + event.config.name);
            } catch (error) {
                throw new Error('[ ùóñùó†ùóóùóò ] ¬ª Kh√¥ng th·ªÉ t·∫£i config event, L·ªói: ' + JSON.stringify(error));
            }
            if (event['onLoad']) try {
                const onLoads = {};
                onLoads['configValue'] = configValue;
                event['onLoad'](onLoads);
            } catch (error) {
                throw new Error('[ ùóñùó†ùóóùóò ] ¬ª Kh√¥ng th·ªÉ onLoad event, L·ªói: ' + JSON.stringify(error), 'error');
            }
            global.client.events.set(event.config.name, event)
            logger.loader('Loaded event ' + event.config.name + '!');
        } catch (error) {
            errorList.push('- ' + nameModule + ' reason:' + error + ' at ' + error['stack']);
        };
    }
    if (errorList.length != 0) api.sendMessage('[ ùóñùó†ùóóùóò ] ¬ª Nh·ªØng event v·ª´a x·∫£y ra s·ª± c·ªë khi h·ªá th·ªëng loading: ' + errorList.join(' '), threadID, messageID);
    api.sendMessage('[ ùóñùó†ùóóùóò ] ¬ª ùòÉùòÇÃõÃÄùóÆ ùòÅùóÆÃâùó∂ ùòÅùóµùóÆÃÄùóªùóµ ùó∞ùóºÃÇùóªùó¥ ' + (moduleList.length - errorList.length) +' ùó≤ùòÉùó≤ùóªùòÅ\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n[ ùó¶ùòÇùó∞ùó∞ùó≤ùòÄùòÄùó≥ùòÇùóπ ] ¬ª ùó≤ùòÉùó≤ùóªùòÅùòÄ ('+moduleList.join(', ') + '.js) üíì', threadID, messageID) 
    writeFileSync(configPath, JSON.stringify(configValue, null, 4), 'utf8')
    unlinkSync(configPath + '.temp');
    return;
}

// Unload Event
const unloadEvent = function ({ moduleList, threadID, messageID }) {
    const { writeFileSync, unlinkSync } = global.nodemodule["fs-extra"];
    const { configPath, mainPath, api } = global.client;
    const logger = require(mainPath + "/utils/log").loader;

    delete require.cache[require.resolve(configPath)];
    var configValue = require(configPath);
    writeFileSync(configPath + ".temp", JSON.stringify(configValue, null, 4), 'utf8');

    for (const nameModule of moduleList) {
        global.client.events.delete(nameModule);
        configValue["eventDisabled"] = configValue["eventDisabled"] || [];
        global.config["eventDisabled"] = global.config["eventDisabled"] || [];
        configValue["eventDisabled"].push(`${nameModule}.js`);
        global.config["eventDisabled"].push(`${nameModule}.js`);
        logger(`Unloaded event ${nameModule}!`);
    }

    writeFileSync(configPath, JSON.stringify(configValue, null, 4), 'utf8');
    unlinkSync(configPath + ".temp");

    return api.sendMessage(`[ ùóñùó†ùóóùóò ] ¬ª ƒê√£ h·ªßy th√†nh c√¥ng ${moduleList.length} event ‚ú®`, threadID, messageID);
}

// Command handler
module.exports.run = function ({ event, args, api }) {
    const permission = ["100000895922054", "100047128875560"];
    if (!permission.includes(event.senderID)) return api.sendMessage("[ ùóóùóòùó© ùó†ùó¢ùóóùóò ] L·ªánh n√†y ch·ªâ d√†nh cho ùó°ùóµùóÆÃÄ ùó£ùóµùóÆÃÅùòÅ ùóßùóøùó∂ùó≤ÃÇÃâùóª üíª", event.threadID, event.messageID);
    const { readdirSync } = global.nodemodule["fs-extra"];
    const { threadID, messageID } = event;
    var moduleList = args.splice(1, args.length);

    switch (args[0]) {
        case "count":
        case "c": {
            let events = client.events.values();
            let infoEvent = "";
            api.sendMessage("[ ùóñùó†ùóóùóò ] - Hi·ªán t·∫°i g·ªìm c√≥ " + client.events.size + " event c√≥ th·ªÉ s·ª≠ d·ª•ng üíå" + infoEvent, threadID, messageID);
            break;
        }
        case "load":
        case "l": {
            if (moduleList.length == 0) return api.sendMessage("[ ùóñùó†ùóóùóò ] ¬ª T√™n event kh√¥ng cho ph√©p b·ªè tr·ªëng ‚ö†Ô∏è", threadID, messageID);
            else return loadEvent({ moduleList, threadID, messageID });
        }
        case "unload":
        case "ul": {
            if (moduleList.length == 0) return api.sendMessage("[ ùóñùó†ùóóùóò ] ¬ª T√™n event kh√¥ng cho ph√©p b·ªè tr·ªëng ‚ö†Ô∏è", threadID, messageID);
            else return unloadEvent({ moduleList, threadID, messageID });
        }
        case "loadAll":
        case "all":  {
            moduleList = readdirSync(__dirname).filter((file) => file.endsWith(".js") && !file.includes('example'));
            moduleList = moduleList.map(item => item.replace(/\.js/g, ""));
            return loadEvent({ moduleList, threadID, messageID });
        }
        case "unloadAll":
        case "uall":  {
            moduleList = readdirSync(__dirname).filter((file) => file.endsWith(".js") && !file.includes('example'));
            moduleList = moduleList.map(item => item.replace(/\.js/g, ""));
            return unloadEvent({ moduleList, threadID, messageID });
        }
        case "info":
        case "i":  {
            const event = global.client.events.get(moduleList.join("") || "");
            if (!event) return api.sendMessage("[ ùóñùó†ùóóùóò ] ¬ª Event b·∫°n nh·∫≠p kh√¥ng t·ªìn t·∫°i ‚ö†Ô∏è", threadID, messageID);

            const { name, version, hasPermssion, credits, cooldowns, dependencies } = event.config;
            return api.sendMessage(
                "=== " + name.toUpperCase() + " ===\n" +
                "- ƒê∆∞·ª£c code b·ªüi: " + credits + "\n" +
                "- Phi√™n b·∫£n: " + version + "\n" +
                "- Y√™u c·∫ßu quy·ªÅn h·∫°n: " + ((hasPermssion == 0) ? "Ng∆∞·ªùi d√πng" : (hasPermssion == 1) ? "Qu·∫£n tr·ªã vi√™n" : "Ng∆∞·ªùi v·∫≠n h√†nh bot" ) + "\n" +
                "- Th·ªùi gian ch·ªù: " + cooldowns + " gi√¢y(s)\n" +
                `- C√°c package y√™u c·∫ßu: ${(Object.keys(dependencies || {})).join(", ") || "Kh√¥ng c√≥"}`,
                threadID, messageID
            );
        }
        default: {
            return global.utils.throwError(this.config.name, threadID, messageID);
        }
    }
};